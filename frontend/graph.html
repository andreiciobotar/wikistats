<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Wikipedia Page Views</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
<link type="text/css" rel="stylesheet" href="css/jquery-ui.min.css">
<link rel="shortcut icon"
	href="http://bits.wikimedia.org/favicon/wikipedia.ico" />

<script src="js/d3.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/purl.js"></script>
<script src="js/rickshaw.min.js"></script>
<script src="js/series.remover.js"></script>


<style>
body {
	padding-top: 60px;
}

#chart {
	height: 500px; //
	width: 887px;
	background-color: #e9e9e9;
}

#footer {
	font-size: -10%;
	margin-top: 30px;
}
</style>

</head>

<body>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<button type="button" class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse">
					<span class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="brand" href="#">Wikipedia Page Views</a>
			</div>
		</div>
	</div>

	<div class="container">
		<noscript>
			<div class="row">
				<div class="span12"
					style="padding: 5px 3px 10px 10px; border: 2px solid red;">
					<p>
						This application requires <a
							ref="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a>.
						Please...
					</p>
				</div>
			</div>
		</noscript>
		<div class="row" id="searchbar">
			<div class="span3">
				<form class="form-search">
					<fieldset>
						<input id="page" type="text"
							placeholder="Start typing a page title hereâ€¦"
							class="search-query">
					</fieldset>
				</form>
			</div>
			<div class="span3">
				<div id="progress"></div>
			</div>
		</div>

		<div class="row">
			<div class="span10">
				<div id="slider"></div>
			</div>
		</div>
		<div class="row">
			<div class="span10">
				<div id="chart"></div>
			</div>
			<div class="span2">
				<div id="legend"></div>
			</div>
		</div>


		<div class="row" id="footer">
			<div class="span12">
				<p>
					<small>Developed at the <a
						href="http://www.cwi.nl/research-groups/Database-Architectures">CWI
							Database Architectures</a> group by <a
						href="http://hannes.muehleisen.org/">Hannes M&uuml;hleisen</a> in
						2013. Powered by <a href="http://www.monetdb.org/">MonetDB</a>, <a
						href="http://code.shutterstock.com/rickshaw/">Rickshaw</a> and <a
						href="http://twitter.github.io/bootstrap/">Bootstrap</a>.<br>Data
						taken from the <a
						href="http://dumps.wikimedia.org/other/pagecounts-raw/">Page
							view statistics for Wikimedia projects</a>. Code is <a
						href="https://github.com/hannesmuehleisen/wikistats">on GitHub</a>.
					</small>
				</p>
			</div>
		</div>
	</div>

	<script>
		(function() {

			var callback = "http://wikistats.ins.cwi.nl/export.php";

			var palette = new Rickshaw.Color.Palette();
			var time = new Rickshaw.Fixtures.Time();
			var tu = time.unit('week');
			var year = time.unit('year');

			var data = [];
			var graph = null;
			var legend = null;
			var highlighter;
			var remover;
			var slider;

			function initGraph() {
				graph = new Rickshaw.Graph({
					element : document.querySelector('#chart'),
					width : $("#chart").width(),
					height : $("#chart").height(),
					renderer : 'line',
					series : data,
					interpolation : "linear"
				});

				var hoverDetail = new Rickshaw.Graph.HoverDetail({
					graph : graph,
					xFormatter : function(x) {
						return tu.formatter(new Date(x * 1000)) + " - "
								+ tu.formatter(new Date((x + 604800) * 1000))
					},
					yFormatter : function(y) {
						return Math.floor(y) + " clicks"
					}
				});

				slider = new Rickshaw.Graph.RangeSlider({
					graph : graph,
					element : document.querySelector('#slider')
				});

			}

			$("#page").autocomplete({
				source : function(request, response) {
					$.ajax({
						url : callback,
						dataType : "jsonp",
						data : {
							suggest : request.term.replace(/ /g, '_')
						},
						success : function(data) {
							response($.map(data, function(item) {
								return {
									label : item.replace(/_/g, ' '),
									value : item
								}
							}));
						}
					});
				},
				minLength : 3,
				select : function(event, ui) {
					addPage(ui.item.value);
					this.value = "";
				},
			});

			function addData(series) {
				$.each(series, function(i, d) {
					d.color = palette.color();
					d.name = d.name.replace(/_/g, ' ');
					data.push(d);
				});

				//Rickshaw.Series.zeroFill(data);

				if (graph == null) {
					initGraph();
				}
				graph.update();
				slider.update();

				$('#legend').empty();

				legend = new Rickshaw.Graph.Legend({
					graph : graph,
					element : document.querySelector('#legend')
				});

				highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
					graph : graph,
					legend : legend
				});

				remover = new Rickshaw.Graph.Behavior.Series.Remove({
					graph : graph,
					legend : legend
				});

				var xAxis = new Rickshaw.Graph.Axis.Time({
					graph : graph
				});

				xAxis.render();

				$('#progress').hide();
				$('#chart').css('background-color', '#fff');
				$("#page").prop('disabled', false);
				$('#page').val('');
				//graph.configure();

			}

			function handleError(err) {
				console.log(err);
			}

			function addPage(terms) {
				if (!$.isArray(terms)) {
					var term = terms;
					terms = [];
					terms.push(term);
				}
				$("#page").prop('disabled', true);

				$('#progress').text('loading...');
				$('#progress').show();
				$('#chart').css('background-color', '#e9e9e9');

				$.ajax({
					url : callback,
					dataType : 'jsonp',
					success : addData,
					error : handleError,
					data : {
						page : terms.join("|")
					}
				});
			}

			// check if we have been given some url parameters to initialize our graph with

			var seriesp = $.url().param('pages')
			if (seriesp != undefined) {
				var terms = seriesp.split("|");
				addPage(terms);
				$('#searchbar').hide();
			}
		})();
	</script>



</body>
</html>
