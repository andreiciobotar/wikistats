<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Wikipedia Clicks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
<link type="text/css" rel="stylesheet" href="css/jquery-ui.min.css">
<link rel="shortcut icon"
	href="http://bits.wikimedia.org/favicon/wikipedia.ico" />

<script src="js/d3.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/purl.js"></script>
<script src="js/rickshaw.min.js"></script>


<style>
body {
	padding-top: 60px;
}

#chart_container {
	display: inline-block;
	font-family: Arial, Helvetica, sans-serif;
}

#chart {
	float: left;
}

#legend {
	float: left;
	margin-left: 15px;
}

#page {
	width: 400px;
}

form {
	padding-top: 20px;
}
</style>

</head>

<body>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<button type="button" class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse">
					<span class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="brand" href="#">Wikipedia Clicks</a>
			</div>
		</div>
	</div>

	<div class="container">

			<div id="progress"></div>


		<div id="chart_container">
			<div id="chart"></div>
			<div id="legend"></div>
		</div>


		<form class="form-search">
			<fieldset>
				<input id="page" type="text"
					placeholder="Start typing a page title hereâ€¦"
					class="input-medium search-query">
			</fieldset>
		</form>


		<p>
			<small>Developed by <a href="http://hannes.muehleisen.org/">Hannes
					M&uuml;hleisen</a> at <a href="http://www.cwi.nl/">CWI</a> in 2013.
				Powered by <a href="http://www.monetdb.org/">MonetDB</a>, <a
				href="http://code.shutterstock.com/rickshaw/">Rickshaw</a> and <a href="http://twitter.github.io/bootstrap/">Bootstrap</a>.<br>Data
				taken from the <a
				href="http://dumps.wikimedia.org/other/pagecounts-raw/">Page
					view statistics for Wikimedia projects</a>. Code is <a
				href="https://github.com/hannesmuehleisen/wikistats">on GitHub</a>.
			</small>
		</p>
	</div>

	<script>
		(function() {

			var callback = "export.php";

			var palette = new Rickshaw.Color.Palette();
			var time = new Rickshaw.Fixtures.Time();
			var tu = time.unit('week');
			var year = time.unit('year');

			var data = [];
			var graph = null;
			var legend = null;
			var highlighter;
			var shelving;

			var width = 750;
			var height = 500;

			$('#chart').width(width);
			$('#chart').height(height);

			function initGraph() {
				graph = new Rickshaw.Graph({
					element : document.querySelector('#chart'),
					width : width,
					height : height,
					renderer : 'line',
					series : data,
					interpolation : "linear"
				});

				var hoverDetail = new Rickshaw.Graph.HoverDetail({
					graph : graph,
					xFormatter : function(x) {
						return tu.formatter(new Date(x * 1000)) + " - "
								+ tu.formatter(new Date((x + 604800) * 1000))
					},
					yFormatter : function(y) {
						return Math.floor(y) + " clicks"
					}
				});

				/*
				var slider = new Rickshaw.Graph.RangeSlider({
				    graph: graph,
				    element: document.querySelector('#slider')
				});
				
					var annotator = new Rickshaw.Graph.Annotate({
					graph : graph,
					element : document.querySelector('#timeline')
				});
					
					$.each(
							[ '2007', '2008', '2009', '2010', '2011', '2012',
									'2013' ], function(i, year) {
								annotator.add(new Date(year + '-02-01').getTime(),
										year);
							});

				
				 */

			}

			$("#page").autocomplete({
				source : function(request, response) {
					$.ajax({
						url : callback,
						dataType : "jsonp",
						data : {
							suggest : request.term.replace(/ /g, '_')
						},
						success : function(data) {
							response($.map(data, function(item) {
								return {
									label : item.replace(/_/g, ' '),
									value : item
								}
							}));
						}
					});
				},
				minLength : 3,
				select : function(event, ui) {
					addPage(ui.item.value);
					this.value = "";
				},
			});

			function addData(series) {
				$.each(series,function(i,d) {
					d.color = palette.color();
					d.name = d.name.replace(/_/g, ' ');
					data.push(d);
				});
				
				//Rickshaw.Series.zeroFill(data);

				if (graph == null) {
					initGraph();
				}
				graph.update();
				$('#legend').empty();

				legend = new Rickshaw.Graph.Legend({
					graph : graph,
					element : document.querySelector('#legend')
				});

				highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
					graph : graph,
					legend : legend
				});

				shelving = new Rickshaw.Graph.Behavior.Series.Toggle({
					graph : graph,
					legend : legend
				});

				var xAxis = new Rickshaw.Graph.Axis.Time({
					graph : graph,
					timeUnit : year
				});

				xAxis.render();
				
				$('#progress').hide();


				//graph.configure();

			}

			function handleError(err) {
				console.log(err);

			}

			
			
			
			
			function addPage(terms) {
				if (!$.isArray(terms)) {
					var term = terms;
					terms = [];
					terms.push(term);
				}
				
			$('#progress').text('loading...');
			$('#progress').show();

				$.ajax({
					url : callback,
					dataType : 'jsonp',
					success : addData,
					error : handleError,
					data : {
						page : terms.join(",")
					}
				});
				
				
			}
			
			
			// check if we have been given some url parameters to initialize our graph with
			
			var seriesp = $.url().param('series')
			if (seriesp != undefined) {
				var terms = seriesp.split(",");				
				addPage(terms);
			}
		})();
	</script>



</body>
</html>